name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: -D warnings

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.89.0
      - uses: Swatinem/rust-cache@v2
      - name: Check
        run: cargo check --all-targets --all-features

  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.89.0
          components: rustfmt
      - name: Check formatting
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.89.0
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.89.0
      - uses: Swatinem/rust-cache@v2
      - name: Run tests
        run: cargo test --all-features

  demo-sim:
    name: Demo Simulation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.89.0
      - uses: Swatinem/rust-cache@v2
      - name: Run demo simulation
        run: |
          cargo run -p demo-sim -- \
            --players 16 \
            --ticks 300 \
            --seed 1 \
            --out-dir target/demo-captures \
            --max-p95-delta-bytes 8192 \
            --max-avg-delta-bytes 4096

  doc:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.89.0
      - uses: Swatinem/rust-cache@v2
      - name: Build docs
        run: cargo doc --no-deps --all-features
        env:
          RUSTDOCFLAGS: -D warnings

  publish-dry-run:
    name: Publish Dry Run
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.89.0
      - uses: Swatinem/rust-cache@v2
      - name: Publish dry-run (sdec-bitstream)
        run: cargo publish -p sdec-bitstream --dry-run

  deny:
    name: Cargo Deny
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.89.0
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-deny
        run: cargo install cargo-deny --locked
      - name: Run cargo-deny
        run: cargo deny check

  simbench:
    name: Simbench Harness
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.89.0
      - uses: Swatinem/rust-cache@v2
      - name: Run simbench
        run: |
          cargo run -p simbench -- \
            --players 16 \
            --ticks 300 \
            --seed 1 \
            --out-dir target/simbench \
            --max-p95-delta-bytes 4096 \
            --max-avg-delta-bytes 2048

  # Ensure fuzz targets compile (actual fuzzing runs periodically, not on every PR)
  fuzz-check:
    name: Fuzz Targets Compile
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz
      - name: Check fuzz targets compile
        run: |
          if [ -d "fuzz" ]; then
            cargo +nightly fuzz check
          else
            echo "No fuzz directory yet, skipping"
          fi
      - name: Run short fuzz smoke test
        run: |
          if [ -d "fuzz" ]; then
            cargo +nightly fuzz run session_packet -- -max_total_time=30
          else
            echo "No fuzz directory yet, skipping"
          fi
