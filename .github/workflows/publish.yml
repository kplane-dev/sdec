name: Publish

on:
  release:
    types: [published]

env:
  CARGO_TERM_COLOR: always

jobs:
  publish:
    name: Publish Crates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Validate release tag matches Cargo.toml version
        run: |
          python3 - <<'PY'
          import os
          import re
          import sys
          import tomllib
          
          tag = os.environ.get("GITHUB_REF_NAME", "")
          if not re.fullmatch(r"v\d+\.\d+\.\d+", tag):
            print(f"Release tag must be in vMAJOR.MINOR.PATCH format, got: {tag}")
            sys.exit(1)
          
          with open("Cargo.toml", "rb") as f:
            data = tomllib.load(f)
          
          version = data.get("workspace", {}).get("package", {}).get("version")
          if not version:
            print("Could not find [workspace.package].version in Cargo.toml")
            sys.exit(1)
          
          expected_tag = f"v{version}"
          if tag != expected_tag:
            print(f"Release tag {tag} does not match workspace version {version}")
            sys.exit(1)
          
          print(f"Release tag {tag} matches workspace version {version}")
          PY

      - name: Run tests
        run: cargo test --workspace

      - name: Publish bitstream
        run: cargo publish -p sdec-bitstream
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Publish wire
        run: cargo publish -p sdec-wire
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Publish schema
        run: cargo publish -p sdec-schema
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Publish codec
        run: cargo publish -p sdec-codec
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Publish repgraph
        run: cargo publish -p sdec-repgraph
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Publish tools
        run: cargo publish -p sdec-tools
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
